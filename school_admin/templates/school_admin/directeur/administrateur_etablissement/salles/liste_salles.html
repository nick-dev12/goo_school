{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Salles - {{ etablissement.nom }}</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'school_admin/css/directeur/salles_clean.css' %}">
</head>
<body>

    {% include 'school_admin/directeur/partials/header_directeur.html' %}
    <div class="page-container">
        <!-- Header -->
        <div class="page-header">
            <div class="header-content">
                <div class="header-title">
                    <i class="fas fa-door-open"></i>
                    <h1>Gestion des Salles</h1>
                    <p>Gérez les salles de {{ etablissement.nom }}</p>
                </div>
                <button class="btn-add-salle" id="addSalleBtn">
                    <i class="fas fa-plus"></i>
                    <span>Ajouter une salle</span>
                </button>
            </div>
        </div>

        <!-- Statistiques -->
        <div class="stats-section">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-door-open"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">{{ stats.total }}</div>
                        <div class="stat-label">Total Salles</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">{{ stats.actives }}</div>
                        <div class="stat-label">Actives</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">{{ stats.inactives }}</div>
                        <div class="stat-label">Inactives</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">{{ stats.total_capacite }}</div>
                        <div class="stat-label">Capacité Totale</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">{{ stats.disponibles }}</div>
                        <div class="stat-label">Disponibles</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-tools"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">{{ stats.maintenance }}</div>
                        <div class="stat-label">En Maintenance</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Liste des salles groupées par type -->
        <div class="salles-section">
            {% if salles_grouped %}
                <!-- Navigation des onglets -->
                <div class="types-tabs">
                    <div class="tabs-nav">
                        {% for type_salle, data in salles_grouped.items %}
                            <button class="tab-btn {% if forloop.first %}active{% endif %}" data-type="{{ data.type }}">
                                <i class="fas fa-{% if data.type == 'classe' %}chalkboard-teacher{% elif data.type == 'laboratoire' %}flask{% elif data.type == 'bibliotheque' %}book{% elif data.type == 'salle_informatique' %}desktop{% elif data.type == 'salle_art' %}palette{% elif data.type == 'salle_musique' %}music{% elif data.type == 'salle_sport' %}dumbbell{% elif data.type == 'amphitheatre' %}theater-masks{% elif data.type == 'salle_reunion' %}users{% elif data.type == 'bureau' %}briefcase{% else %}door-open{% endif %}"></i>
                                <span>{{ type_salle }}</span>
                                <span class="tab-count">({{ data.salles|length }})</span>
                            </button>
                        {% endfor %}
                    </div>
                </div>

                <!-- Contenu des onglets -->
                <div class="tabs-content">
                    {% for type_salle, data in salles_grouped.items %}
                        <div class="tab-panel {% if forloop.first %}active{% endif %}" id="type-{{ data.type }}">
                            <!-- En-tête du type -->
                            <div class="type-header">
                                <div class="type-info">
                                    <h3 class="type-title">
                                        <i class="fas fa-{% if data.type == 'classe' %}chalkboard-teacher{% elif data.type == 'laboratoire' %}flask{% elif data.type == 'bibliotheque' %}book{% elif data.type == 'salle_informatique' %}desktop{% elif data.type == 'salle_art' %}palette{% elif data.type == 'salle_musique' %}music{% elif data.type == 'salle_sport' %}dumbbell{% elif data.type == 'amphitheatre' %}theater-masks{% elif data.type == 'salle_reunion' %}users{% elif data.type == 'bureau' %}briefcase{% else %}door-open{% endif %}"></i>
                                        {{ type_salle }}
                                    </h3>
                                    <p class="type-subtitle">{{ data.salles|length }} salle{{ data.salles|length|pluralize }}</p>
                                </div>
                                <div class="type-stats">
                                    <div class="stat-item">
                                        <span class="stat-number">{{ data.total_capacite }}</span>
                                        <span class="stat-label">Capacité</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-number">{{ data.salles_disponibles }}</span>
                                        <span class="stat-label">Disponibles</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-number">{{ data.salles_occupees }}</span>
                                        <span class="stat-label">Occupées</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-number">{{ data.salles_maintenance }}</span>
                                        <span class="stat-label">Maintenance</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Grille des salles de ce type -->
                            <div class="salles-grid">
                                {% for salle in data.salles %}
                                    <div class="salle-card">
                                        <div class="salle-header">
                                            <div class="salle-icon">
                                                <i class="fas fa-{% if salle.type_salle == 'classe' %}chalkboard-teacher{% elif salle.type_salle == 'laboratoire' %}flask{% elif salle.type_salle == 'bibliotheque' %}book{% elif salle.type_salle == 'salle_informatique' %}desktop{% elif salle.type_salle == 'salle_art' %}palette{% elif salle.type_salle == 'salle_musique' %}music{% elif salle.type_salle == 'salle_sport' %}dumbbell{% elif salle.type_salle == 'amphitheatre' %}theater-masks{% elif salle.type_salle == 'salle_reunion' %}users{% elif salle.type_salle == 'bureau' %}briefcase{% else %}door-open{% endif %}"></i>
                                            </div>
                                            <div class="salle-info">
                                                <h3 class="salle-nom">{{ salle.nom }}</h3>
                                                <p class="salle-numero">{{ salle.numero }}</p>
                                                <div class="salle-badge type-{{ salle.type_salle }}">
                                                    <span>{{ salle.type_display }}</span>
                                                </div>
                                            </div>
                                            <div class="salle-status">
                                                <div class="status-badge status-{{ salle.etat }}">
                                                    <i class="fas fa-{% if salle.etat == 'disponible' %}check-circle{% elif salle.etat == 'occupee' %}times-circle{% elif salle.etat == 'maintenance' %}tools{% else %}lock{% endif %}"></i>
                                                    <span>{{ salle.etat_display }}</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="salle-details">
                                            <!-- Informations principales -->
                                            <div class="detail-row">
                                                <div class="detail-item">
                                                    <i class="fas fa-users"></i>
                                                    <span class="detail-label">Capacité:</span>
                                                    <span class="detail-value">{{ salle.capacite_max }}</span>
                                                </div>
                                                <div class="detail-item">
                                                    <i class="fas fa-calendar-plus"></i>
                                                    <span class="detail-label">Créée:</span>
                                                    <span class="detail-value">{{ salle.date_creation|date:"d/m/Y" }}</span>
                                                </div>
                                            </div>
                                            
                                            <!-- Informations secondaires -->
                                            <div class="detail-row">
                                                <div class="detail-item">
                                                    <i class="fas fa-edit"></i>
                                                    <span class="detail-label">Modifiée:</span>
                                                    <span class="detail-value">{{ salle.date_modification|date:"d/m/Y" }}</span>
                                                </div>
                                                <div class="detail-item">
                                                    <i class="fas fa-building"></i>
                                                    <span class="detail-label">Type:</span>
                                                    <span class="detail-value">{{ salle.type_display }}</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="salle-actions">
                                            <a href="{% url 'salle:detail_salle' salle.id %}" class="btn-action btn-detail">
                                                <i class="fas fa-eye"></i>
                                                <span>Détails</span>
                                            </a>
                                            <a href="{% url 'salle:toggle_actif' salle.id %}" class="btn-action btn-toggle {% if salle.actif %}active{% endif %}">
                                                <i class="fas fa-{% if salle.actif %}pause{% else %}play{% endif %}"></i>
                                                <span>{% if salle.actif %}Désactiver{% else %}Activer{% endif %}</span>
                                            </a>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-door-open"></i>
                    </div>
                    <h3>Aucune salle trouvée</h3>
                    <p>Commencez par ajouter des salles à votre établissement</p>
                    <button class="btn-add-salle" id="addSalleBtnEmpty">
                        <i class="fas fa-plus"></i>
                        <span>Ajouter la première salle</span>
                    </button>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Modal d'ajout de salle -->
    <div class="modal-overlay" id="addSalleModal">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-plus"></i>
                    Ajouter une nouvelle salle
                </h2>
                <button class="modal-close" id="closeModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form class="modal-form" method="post" action="{% url 'salle:ajouter_salle' %}">
                {% csrf_token %}
                <div class="form-group">
                    <label for="nom" class="form-label">Nom de la salle *</label>
                    <input type="text" id="nom" name="nom" class="form-control" placeholder="Ex: Salle de Sciences, Laboratoire 1, etc." required>
                </div>
                
                <div class="form-group">
                    <label for="numero" class="form-label">Numéro de salle *</label>
                    <input type="text" id="numero" name="numero" class="form-control" placeholder="Ex: A101, LAB-01, etc." required>
                </div>
                
                <div class="form-group">
                    <label for="type_salle" class="form-label">Type de salle *</label>
                    <select id="type_salle" name="type_salle" class="form-control" required>
                        <option value="">Sélectionnez un type</option>
                        <option value="classe">Salle de Classe</option>
                        <option value="laboratoire">Laboratoire</option>
                        <option value="bibliotheque">Bibliothèque</option>
                        <option value="salle_informatique">Salle d'Informatique</option>
                        <option value="salle_art">Salle d'Arts</option>
                        <option value="salle_musique">Salle de Musique</option>
                        <option value="salle_sport">Salle de Sport</option>
                        <option value="amphitheatre">Amphithéâtre</option>
                        <option value="salle_reunion">Salle de Réunion</option>
                        <option value="bureau">Bureau</option>
                        <option value="autre">Autre</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="capacite_max" class="form-label">Capacité maximale *</label>
                    <input type="number" id="capacite_max" name="capacite_max" class="form-control" min="1" placeholder="30" required>
                </div>
                
                <div class="form-group">
                    <label for="etat" class="form-label">État de la salle</label>
                    <select id="etat" name="etat" class="form-control">
                        <option value="disponible">Disponible</option>
                        <option value="occupee">Occupée</option>
                        <option value="maintenance">En Maintenance</option>
                        <option value="fermee">Fermée</option>
                    </select>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" id="cancelAdd">
                        <i class="fas fa-times"></i>
                        Annuler
                    </button>
                    <button type="submit" class="btn-submit">
                        <i class="fas fa-save"></i>
                        Ajouter la salle
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const addSalleBtn = document.getElementById('addSalleBtn');
            const addSalleBtnEmpty = document.getElementById('addSalleBtnEmpty');
            const modal = document.getElementById('addSalleModal');
            const closeModal = document.getElementById('closeModal');
            const cancelBtn = document.getElementById('cancelAdd');

            function openModal() {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }

            function closeModalFunc() {
                modal.classList.remove('active');
                document.body.style.overflow = 'auto';
            }

            if (addSalleBtn) {
                addSalleBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    openModal();
                });
            }

            if (addSalleBtnEmpty) {
                addSalleBtnEmpty.addEventListener('click', function(e) {
                    e.preventDefault();
                    openModal();
                });
            }

            if (closeModal) {
                closeModal.addEventListener('click', closeModalFunc);
            }

            if (cancelBtn) {
                cancelBtn.addEventListener('click', closeModalFunc);
            }

            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeModalFunc();
                    }
                });
            }

            // Gestion des onglets de types
            const typeTabs = document.querySelectorAll('.tab-btn[data-type]');
            const typePanels = document.querySelectorAll('.tab-panel[id^="type-"]');

            typeTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const type = this.getAttribute('data-type');
                    
                    // Retirer la classe active de tous les onglets et panneaux
                    typeTabs.forEach(t => t.classList.remove('active'));
                    typePanels.forEach(p => p.classList.remove('active'));
                    
                    // Ajouter la classe active à l'onglet cliqué et au panneau correspondant
                    this.classList.add('active');
                    const targetPanel = document.getElementById(`type-${type}`);
                    if (targetPanel) {
                        targetPanel.classList.add('active');
                    }
                });
            });

            // Fermer le modal avec la touche Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal.classList.contains('active')) {
                    closeModalFunc();
                }
            });
        });
    </script>
</body>
</html>
