<!DOCTYPE html>
{% load static notes_tags %}
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noter les élèves - {{ classe.nom }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'school_admin/css/enseignant/header_enseignant_new.css' %}">
    <link rel="stylesheet" href="{% static 'school_admin/css/enseignant/noter_eleves.css' %}">
</head>
<body>
    {% include 'school_admin/enseignant/partials/header_enseignant_new.html' %}

    <!-- Main Content -->
    <div class="main-content-container">
        <!-- Fil d'Ariane -->
        <div class="breadcrumb">
            <a href="{% url 'enseignant:dashboard_enseignant' %}">Tableau de bord</a>
            <i class="fas fa-chevron-right"></i>
            <a href="{% url 'enseignant:gestion_notes' %}">Gestion des notes</a>
            <i class="fas fa-chevron-right"></i>
            <span>Noter les élèves</span>
        </div>

        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">
                    <i class="fas fa-info-circle"></i>
                    <p>{{ message }}</p>
                </div>
            {% endfor %}
        {% endif %}

        <!-- Statut du relevé -->
        {% if releve_notes.soumis %}
            <div class="releve-status-banner soumis">
                <div class="status-icon">
                    <i class="fas fa-lock"></i>
                </div>
                <div class="status-text">
                    <strong>Relevé de notes soumis</strong>
                    <p>Ce relevé a été soumis le {{ releve_notes.date_soumission|date:"d/m/Y à H:i" }}. Les modifications sont désormais verrouillées.</p>
                </div>
            </div>
        {% else %}
            <div class="releve-status-banner en-cours">
                <div class="status-icon">
                    <i class="fas fa-edit"></i>
                </div>
                <div class="status-text">
                    <strong>Relevé de notes en cours</strong>
                    <p>Vous pouvez encore modifier les notes et les évaluations. N'oubliez pas de soumettre le relevé une fois terminé.</p>
                </div>
            </div>
        {% endif %}

        <!-- Page Header -->
        <div class="page-header">
            <div class="page-title-section">
                <h1 class="page-title">
                    <i class="fas fa-edit"></i>
                    Notation des élèves
                </h1>
                <p class="page-subtitle">
                    {{ classe.nom }} - {{ matiere.nom }} - {{ eleves.count }} élève{{ eleves.count|pluralize }}
                </p>
            </div>
        </div>

        <!-- Onglets de périodes -->
        <div class="periodes-tabs">
            <div class="tabs-container">
                {% for periode_code, periode_nom in PERIODES %}
                    {% if periode_code != 'annuel' %}
                        <a href="?periode={{ periode_code }}" 
                           class="periode-tab {% if periode_active == periode_code %}active{% endif %}">
                            <i class="fas fa-calendar-check"></i>
                            <span>{{ periode_nom }}</span>
                            {% with releve=tous_releves|dictsort:"periode" %}
                                {% for r in tous_releves %}
                                    {% if r.periode == periode_code %}
                                        {% if r.soumis %}
                                            <span class="tab-badge soumis">
                                                <i class="fas fa-lock"></i>
                                            </span>
                                        {% else %}
                                            <span class="tab-badge en-cours">
                                                <i class="fas fa-edit"></i>
                                            </span>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            {% endwith %}
                        </a>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Information de la classe -->
        <div class="classe-info-card">
            <div class="info-item">
                <i class="fas fa-chalkboard"></i>
                <span><strong>Classe :</strong> {{ classe.nom }}</span>
            </div>
            <div class="info-item">
                <i class="fas fa-book"></i>
                <span><strong>Matière :</strong> {{ matiere.nom }}</span>
            </div>
            <div class="info-item">
                <i class="fas fa-users"></i>
                <span><strong>Effectif :</strong> {{ eleves.count }} élève{{ eleves.count|pluralize }}</span>
            </div>
            {% if affectation.est_principal %}
                <div class="info-item">
                    <i class="fas fa-crown"></i>
                    <span><strong>Statut :</strong> Professeur Principal</span>
                </div>
            {% endif %}
        </div>

        {% if eleves %}
            <!-- Formulaire de notation -->
            <form method="post" id="notationForm" class="notation-form">
                {% csrf_token %}
                
                <!-- Section de sélection des notes -->
                <div class="notes-selection-container">
                    <div class="selection-header">
                        <div class="selection-header-left">
                            <div class="selection-icon">
                                <i class="fas fa-tasks"></i>
                            </div>
                            <div class="selection-header-text">
                                <h3>Sélection des évaluations</h3>
                                <p>Cochez les colonnes à inclure dans le calcul</p>
                            </div>
                        </div>
                        <div class="selection-counter">
                            <span class="counter-number" id="selectedCount">0</span>
                            <span class="counter-label">sélectionnée(s)</span>
                        </div>
                    </div>
                    
                    {% if not has_evaluations %}
                        <div class="alert-warning-compact">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>Aucune évaluation programmée</span>
                            <a href="{% url 'enseignant:creer_evaluation' classe.id %}" class="btn-create-mini">
                                <i class="fas fa-plus"></i> Créer
                            </a>
                        </div>
                    {% endif %}

                    <div class="evaluations-grid">
                        {% for item in evaluations_liste %}
                            <div class="eval-card" data-type="{{ item.type }}">
                                <input type="checkbox" 
                                       id="select_{{ item.key }}" 
                                       name="select_{{ item.key }}"
                                       class="eval-checkbox global-note-select" 
                                       data-note-key="{{ item.key }}" 
                                       data-type="{{ item.type }}"
                                       {% if releve_notes.soumis %}disabled{% endif %}>
                                <label for="select_{{ item.key }}" class="eval-card-label">
                                    <div class="eval-card-header">
                                        <div class="eval-icon {% if item.type == 'interrogation' %}eval-icon-interro{% else %}eval-icon-devoir{% endif %}">
                                            {% if item.type == 'interrogation' %}
                                                <i class="fas fa-question-circle"></i>
                                            {% else %}
                                                <i class="fas fa-file-alt"></i>
                                            {% endif %}
                                        </div>
                                        <div class="eval-bareme">/{{ item.evaluation.bareme|floatformat:0 }}</div>
                                    </div>
                                    <div class="eval-card-body">
                                        <div class="eval-title">{{ item.evaluation.titre|truncatewords:4 }}</div>
                                        <div class="eval-type-badge">
                                            {{ item.titre_court }}
                                        </div>
                                    </div>
                                    <div class="eval-check-overlay">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                </label>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Actions formulaire -->
                <div class="notation-actions">
                    <button type="button" 
                            onclick="calculerToutesMoyennes()" 
                            class="btn btn-secondary"
                            {% if releve_notes.soumis %}disabled{% endif %}>
                        <i class="fas fa-calculator"></i> Calculer les moyennes
                    </button>
                    <button type="submit" 
                            name="submit_notes" 
                            class="btn btn-primary"
                            {% if releve_notes.soumis %}disabled{% endif %}>
                        <i class="fas fa-save"></i> Enregistrer les notes
                    </button>
                    {% if not releve_notes.soumis %}
                        <button type="button" 
                                onclick="if(confirm('Êtes-vous sûr de vouloir soumettre ce relevé ? Cette action est irréversible et verrouillera toutes les notes.')) { window.location.href='{% url 'enseignant:soumettre_releve' classe.id %}'; }"
                                class="btn btn-success">
                            <i class="fas fa-paper-plane"></i> Soumettre le relevé
                        </button>
                    {% else %}
                        <div class="btn btn-locked" disabled>
                            <i class="fas fa-lock"></i> Relevé soumis
                        </div>
                    {% endif %}
                </div>

                <!-- Tableau de notation -->
                <div class="notation-table-container">
                    <table class="notation-table">
                        <thead>
                            <tr>
                                <th rowspan="2" class="eleve-col">Élève</th>
                                {% if evaluations_interrogations %}
                                    <th colspan="{{ evaluations_interrogations|length }}" class="notes-header">Interrogations</th>
                                {% endif %}
                                {% if evaluations_devoirs %}
                                    <th colspan="{{ evaluations_devoirs|length }}" class="notes-header">Devoirs / Contrôles</th>
                                {% endif %}
                                <th rowspan="2" class="moyenne-col">Moyenne<br>(/20)</th>
                            </tr>
                            <tr>
                                {% for eval in evaluations_interrogations %}
                                    <th class="note-col has-evaluation">
                                        {{ eval.titre|truncatewords:2 }}
                                        <br><small>/{{ eval.bareme|floatformat:0 }}</small>
                                        <i class="fas fa-check-circle"></i>
                                    </th>
                                {% endfor %}
                                {% for eval in evaluations_devoirs %}
                                    <th class="note-col has-evaluation">
                                        {{ eval.titre|truncatewords:2 }}
                                        <br><small>/{{ eval.bareme|floatformat:0 }}</small>
                                        <i class="fas fa-check-circle"></i>
                                    </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for eleve in eleves %}
                                <tr class="{% cycle 'row-even' 'row-odd' %}" data-eleve-id="{{ eleve.id }}">
                                    <td class="eleve-cell">
                                        <div class="eleve-info-notation">
                                            <div class="eleve-avatar-tiny">
                                                {{ eleve.prenom.0 }}{{ eleve.nom.0 }}
                                            </div>
                                            <span class="eleve-nom">{{ eleve.nom|upper }} {{ eleve.prenom }}</span>
                                        </div>
                                    </td>
                                    
                                    {% for item in evaluations_liste %}
                                        {% with note_value=notes_existantes|get_note:eleve.id|get_note:item.key %}
                                        <td class="note-cell has-evaluation {% if note_value %}note-saved{% endif %}">
                                            <input type="number" 
                                                   name="note_{{ eleve.id }}_{{ item.key }}" 
                                                   class="note-input {% if note_value %}saved {{ note_value|get_note_color_class:item.evaluation.bareme }}{% endif %}{% if releve_notes.soumis %} locked{% endif %}" 
                                                   min="0" 
                                                   max="{{ item.evaluation.bareme }}" 
                                                   step="0.5" 
                                                   value="{{ note_value|format_note }}"
                                                   placeholder="--"
                                                   data-type="{{ item.type }}" 
                                                   data-max="{{ item.evaluation.bareme }}"
                                                   data-note-key="{{ item.key }}"
                                                   data-eval-id="{{ item.evaluation.id }}"
                                                   {% if releve_notes.soumis %}readonly{% endif %}
                                                   onchange="colorNote(this)">
                                        </td>
                                        {% endwith %}
                                    {% endfor %}
                                    
                                    <!-- Moyenne -->
                                    <td class="moyenne-cell">
                                        <input type="text" 
                                               id="moyenne_{{ eleve.id }}" 
                                               name="notes[{{ eleve.id }}][moyenne]" 
                                               value="{% if moyennes_enregistrees|get_note:eleve.id %}{{ moyennes_enregistrees|get_note:eleve.id|get_note:'moyenne'|format_note }}{% else %}--{% endif %}" 
                                               class="moyenne-input {% if moyennes_enregistrees|get_note:eleve.id %}has-moyenne{% endif %}" 
                                               readonly
                                               data-eleve-id="{{ eleve.id }}">
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Actions du bas -->
                <div class="notation-actions bottom">
                    <button type="button" 
                            onclick="calculerToutesMoyennes()" 
                            class="btn btn-secondary"
                            {% if releve_notes.soumis %}disabled{% endif %}>
                        <i class="fas fa-calculator"></i> Calculer les moyennes
                    </button>
                    <button type="submit" 
                            name="submit_notes" 
                            class="btn btn-primary"
                            {% if releve_notes.soumis %}disabled{% endif %}>
                        <i class="fas fa-save"></i> Enregistrer les notes
                    </button>
                    {% if not releve_notes.soumis %}
                        <button type="button" 
                                onclick="if(confirm('Êtes-vous sûr de vouloir soumettre ce relevé ? Cette action est irréversible et verrouillera toutes les notes.')) { window.location.href='{% url 'enseignant:soumettre_releve' classe.id %}'; }"
                                class="btn btn-success">
                            <i class="fas fa-paper-plane"></i> Soumettre le relevé
                        </button>
                    {% endif %}
                    <a href="{% url 'enseignant:gestion_notes' %}" class="btn btn-outline">
                        <i class="fas fa-arrow-left"></i> Retour
                    </a>
                </div>
            </form>
        {% else %}
            <!-- État vide -->
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-users-slash"></i>
                </div>
                <h3>Aucun élève dans cette classe</h3>
                <p>Cette classe ne contient actuellement aucun élève actif.</p>
                <a href="{% url 'enseignant:gestion_notes' %}" class="btn btn-primary">
                    <i class="fas fa-arrow-left"></i> Retour
                </a>
            </div>
        {% endif %}
    </div>

    <script src="{% static 'school_admin/js/enseignant/header_enseignant.js' %}"></script>
    <script>
        // Fonction pour activer/désactiver la sélection des notes pour tous les élèves
        function toggleNoteSelectionForAll(checkbox) {
            const noteKey = checkbox.dataset.noteKey;
            const isChecked = checkbox.checked;
            
            // Vérifier le nombre de notes sélectionnées
            if (isChecked) {
                const checkedGlobalNotes = document.querySelectorAll('.global-note-select:checked');
                if (checkedGlobalNotes.length > 2) {
                    alert('Vous ne pouvez sélectionner que 2 notes maximum pour le calcul de la moyenne.');
                    checkbox.checked = false;
                    return;
                }
            }
            
            // Mettre à jour visuellement l'item
            const parentItem = checkbox.closest('.note-select-item');
            if (isChecked) {
                parentItem.classList.add('selected');
            } else {
                parentItem.classList.remove('selected');
            }
        }
        
        // Fonction pour colorier une note selon sa valeur
        function colorNote(input) {
            const value = parseFloat(input.value);
            if (isNaN(value) || value === 0) {
                input.style.color = '#64748b';
                return;
            }
            
            const maxNote = parseFloat(input.dataset.max);
            const percentage = value / maxNote;
            
            if (percentage < 0.25) {
                input.style.color = '#ef4444'; // Rouge
            } else if (percentage < 0.5) {
                input.style.color = '#f59e0b'; // Orange
            } else if (percentage < 0.75) {
                input.style.color = '#3b82f6'; // Bleu
            } else {
                input.style.color = '#10b981'; // Vert
            }
        }
        
        // Fonction pour calculer la moyenne d'un élève
        function calculerMoyenne(eleveId) {
            const row = document.querySelector(`tr[data-eleve-id="${eleveId}"]`);
            if (!row) return;
            
            // Récupérer les notes sélectionnées
            const selectedNotes = document.querySelectorAll('.global-note-select:checked');
            if (selectedNotes.length === 0) {
                document.getElementById(`moyenne_${eleveId}`).value = "0.00";
                return;
            }
            
            // Regrouper par type
            const notesByType = {};
            
            selectedNotes.forEach(checkbox => {
                const noteKey = checkbox.dataset.noteKey;
                const noteType = checkbox.dataset.type;
                
                if (!notesByType[noteType]) {
                    notesByType[noteType] = [];
                }
                
                const noteInput = row.querySelector(`input[data-note-key="${noteKey}"]`);
                if (noteInput) {
                    const noteValue = parseFloat(noteInput.value) || 0;
                    const maxNote = parseFloat(noteInput.dataset.max);
                    
                    // Convertir sur 20
                    const noteSur20 = (noteValue / maxNote) * 20;
                    notesByType[noteType].push(noteSur20);
                }
            });
            
            // Calculer la moyenne pour chaque type
            let totalNote = 0;
            let nbTypes = 0;
            
            for (const type in notesByType) {
                const notes = notesByType[type];
                const moyenneType = notes.reduce((a, b) => a + b, 0) / notes.length;
                totalNote += moyenneType;
                nbTypes++;
            }
            
            // Calculer la moyenne finale
            const moyenne = nbTypes > 0 ? totalNote / nbTypes : 0;
            const moyenneInput = document.getElementById(`moyenne_${eleveId}`);
            moyenneInput.value = moyenne.toFixed(2);
            
            // Colorier la moyenne
            const percentage = moyenne / 20;
            if (percentage < 0.25) {
                moyenneInput.style.color = '#ef4444';
            } else if (percentage < 0.5) {
                moyenneInput.style.color = '#f59e0b';
            } else if (percentage < 0.75) {
                moyenneInput.style.color = '#3b82f6';
            } else {
                moyenneInput.style.color = '#10b981';
            }
        }
        
        // Fonction pour calculer toutes les moyennes (appel backend)
        function calculerToutesMoyennes() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            
            // Récupérer les colonnes sélectionnées
            const colonnesSelectionnees = [];
            document.querySelectorAll('.global-note-select:checked').forEach(checkbox => {
                colonnesSelectionnees.push(checkbox.dataset.noteKey);
            });
            
            // Vérifier qu'au moins une colonne est sélectionnée
            if (colonnesSelectionnees.length === 0) {
                alert('Veuillez sélectionner au moins une colonne de notes pour calculer les moyennes.');
                return;
            }
            
            // Désactiver le bouton pendant le calcul
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calcul en cours...';
            
            // Appel AJAX au backend avec les colonnes sélectionnées et la période
            fetch("{% url 'enseignant:calculer_moyennes' classe.id %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    colonnes_selectionnees: colonnesSelectionnees,
                    periode: '{{ periode_active }}'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mettre à jour les moyennes affichées
                    data.moyennes.forEach(moyenneData => {
                        const moyenneInput = document.getElementById(`moyenne_${moyenneData.eleve_id}`);
                        if (moyenneInput) {
                            moyenneInput.value = moyenneData.moyenne.toFixed(2);
                            moyenneInput.classList.add('has-moyenne');
                            
                            // Colorier la moyenne
                            const percentage = moyenneData.moyenne / 20;
                            if (percentage < 0.4) {
                                moyenneInput.style.color = '#ef4444'; // Rouge
                                moyenneInput.style.fontWeight = '700';
                            } else if (percentage < 0.5) {
                                moyenneInput.style.color = '#f59e0b'; // Orange
                                moyenneInput.style.fontWeight = '700';
                            } else if (percentage < 0.7) {
                                moyenneInput.style.color = '#3b82f6'; // Bleu
                                moyenneInput.style.fontWeight = '700';
                            } else {
                                moyenneInput.style.color = '#10b981'; // Vert
                                moyenneInput.style.fontWeight = '700';
                            }
                        }
                    });
                    
                    // Message de succès
                    btn.innerHTML = '<i class="fas fa-check"></i> ' + data.message;
                    btn.style.background = '#10b981';
                    
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.style.background = '';
                        btn.disabled = false;
                    }, 3000);
                } else {
                    // Message d'erreur
                    alert('Erreur : ' + data.error);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Erreur lors du calcul des moyennes');
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }
        
        // ========================================
        // Compteur de sélection dynamique
        // ========================================
        function updateSelectionCounter() {
            const selectedCount = document.querySelectorAll('.eval-checkbox:checked').length;
            const counterElement = document.getElementById('selectedCount');
            
            if (counterElement) {
                counterElement.textContent = selectedCount;
                
                // Animation du compteur
                counterElement.style.transform = 'scale(1.3)';
                counterElement.style.transition = 'transform 0.2s';
                setTimeout(() => {
                    counterElement.style.transform = 'scale(1)';
                }, 200);
            }
        }
        
        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            // Colorier toutes les notes existantes
            document.querySelectorAll('.note-input').forEach(input => {
                colorNote(input);
            });
            
            // Colorier les moyennes enregistrées
            document.querySelectorAll('.moyenne-input.has-moyenne').forEach(input => {
                const value = parseFloat(input.value);
                if (!isNaN(value) && value > 0) {
                    const percentage = value / 20;
                    if (percentage < 0.4) {
                        input.style.color = '#ef4444'; // Rouge
                        input.style.fontWeight = '700';
                    } else if (percentage < 0.5) {
                        input.style.color = '#f59e0b'; // Orange
                        input.style.fontWeight = '700';
                    } else if (percentage < 0.7) {
                        input.style.color = '#3b82f6'; // Bleu
                        input.style.fontWeight = '700';
                    } else {
                        input.style.color = '#10b981'; // Vert
                        input.style.fontWeight = '700';
                    }
                }
            });
            
            // Initialiser le compteur
            updateSelectionCounter();
            
            // Écouter les changements sur les checkboxes
            document.querySelectorAll('.eval-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateSelectionCounter);
            });
        });
    </script>
</body>
</html>

