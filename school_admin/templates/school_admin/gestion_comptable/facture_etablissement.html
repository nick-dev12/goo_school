{% load static %}
<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Facture - Goo-School</title>
    <link
      rel="stylesheet"
      href="{% static 'school_admin/css/gestion_comptable/header_comptable.css' %}"
    />
    <link
      rel="stylesheet"
      href="{% static 'school_admin/css/gestion_comptable/facture_etablissement.css' %}"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
  </head>
  <body>
    {% include 'school_admin/gestion_comptable/partials/header_comptable.html'%}

      <div class="invoice-container">
        <!-- Messages Django -->
        {% include 'school_admin/partials/messages.html' %}
        
        <!-- Invoice Actions -->
      <div class="invoice-actions">
        <button class="btn btn-outline" onclick="goBack()">
          <i class="fas fa-arrow-left"></i> Retour
        </button>
        <button class="btn btn-primary" onclick="printInvoice()">
          <i class="fas fa-print"></i> Imprimer
        </button>
        <button class="btn btn-success" onclick="downloadPDF()">
          <i class="fas fa-download"></i> Télécharger PDF
        </button>
        {% if not facture_info.statut_envoi %}
        <form method="POST" action="{% url 'school_admin:envoyer_facture' facture_info.numero etablissement.id %}" style="display: inline;">
          {% csrf_token %}
          <button type="submit" class="btn btn-secondary">
            <i class="fas fa-paper-plane"></i> Marquer comme Envoyée
          </button>
        </form>
        {% else %}
        <button class="btn btn-success" disabled>
          <i class="fas fa-check-circle"></i> Facture Envoyée
        </button>
        {% endif %}
      </div>

      <!-- Invoice Document -->
      <div class="invoice-document" id="invoiceDocument">
        <!-- Invoice Status -->
        <div class="invoice-status-header">
          <div class="status-badge {% if facture_info.statut == 'Payé' %}paid{% else %}pending{% endif %}">
            <i class="fas fa-{% if facture_info.statut == 'Payé' %}check-circle{% else %}clock{% endif %}"></i>
            <span>FACTURE {{ facture_info.statut|upper }}</span>
          </div>
          <div class="payment-date">
            {% if facture_info.date_paiement %}
            <p>Payée le : {{ facture_info.date_paiement|date:"d F Y" }}</p>
            {% if facture_info.mode_paiement %}
            <p>Méthode : {{ facture_info.mode_paiement }}</p>
            {% endif %}
            {% else %}
            <p>En attente de paiement</p>
            {% endif %}
            {% if facture_info.statut_envoi %}
            <p style="color: #059669; font-weight: 600;"><i class="fas fa-paper-plane"></i> Envoyée à l'établissement</p>
            {% else %}
            <p style="color: #f59e0b; font-weight: 600;"><i class="fas fa-clock"></i> En attente d'envoi</p>
            {% endif %}
          </div>
        </div>

        <!-- Invoice Header -->
        <div class="invoice-header">
          <div class="company-info">
            <div class="company-logo">
              <i class="fas fa-graduation-cap"></i>
              <span>Goo-School</span>
            </div>
            <div class="company-details">
              <h2>{{ company_info.nom }}</h2>
              <p>{{ company_info.description }}</p>
              <p><i class="fas fa-map-marker-alt"></i> {{ company_info.adresse }}</p>
              <p><i class="fas fa-phone"></i> {{ company_info.telephone }}</p>
              <p><i class="fas fa-envelope"></i> {{ company_info.email }}</p>
            </div>
          </div>
          <div class="invoice-title">
            <h1>FACTURE</h1>
            <div class="invoice-number">
              <span>N° {{ facture_info.numero }}</span>
            </div>
          </div>
        </div>

        <!-- Invoice Details -->
        <div class="invoice-details">
          <div class="bill-to">
            <h3>Facturer à :</h3>
            <div class="client-info">
              <h4>{{ etablissement_info.nom }}</h4>
              <p><strong>Directeur :</strong> {{ etablissement_info.directeur }}</p>
              <p><strong>Adresse :</strong> {{ etablissement_info.adresse }}</p>
              {% if etablissement_info.telephone %}
              <p><strong>Téléphone :</strong> {{ etablissement_info.telephone }}</p>
              {% endif %}
              {% if etablissement_info.email %}
              <p><strong>Email :</strong> {{ etablissement_info.email }}</p>
              {% endif %}
              <p><strong>Type :</strong> {{ etablissement_info.type }}</p>
            </div>
          </div>
          <div class="invoice-info">
            <h3>Informations de Facturation :</h3>
            <div class="info-grid">
              <div class="info-item">
                <label>Date d'émission :</label>
                <span>{{ facture_info.date_emission|date:"d F Y" }}</span>
              </div>
              <div class="info-item">
                <label>Date d'échéance :</label>
                <span>{{ facture_info.date_echeance|date:"d F Y" }}</span>
              </div>
              <div class="info-item">
                <label>Type de facture :</label>
                <span>{{ facture_info.type_facture }}</span>
              </div>
              {% if facture_info.mode_paiement %}
              <div class="info-item">
                <label>Méthode de paiement :</label>
                <span>{{ facture_info.mode_paiement }}</span>
              </div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Invoice Items -->
        <div class="invoice-items">
          <h3>Détail des Services :</h3>
          <table class="items-table">
            <thead>
              <tr>
                <th>Description</th>
                <th>Quantité</th>
                <th>Prix Unitaire</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>
                  <div class="item-description">
                    <strong>{{ facture_info.description }}</strong>
                    {% if facture.est_facture_service %}
                    <p>{{ facture_info.type_facture }} - {{ facture_info.quantite }} élèves inscrits</p>
                    <p>Inclut : Gestion des élèves, bulletins, communication, etc.</p>
                    {% elif facture.est_facture_module %}
                    <p>Modules supplémentaires : {{ facture.get_modules_supplementaires_display }}</p>
                    {% endif %}
                  </div>
                </td>
                <td>{{ facture_info.quantite }}</td>
                <td>{{ facture_info.montant_unitaire|floatformat:0 }} FCFA</td>
                <td>{{ facture_info.montant_total|floatformat:0 }} FCFA</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Invoice Totals -->
        <div class="invoice-totals">
          <div class="totals-table">
            <div class="total-row">
              <span>Montant total :</span>
              <span>{{ facture_info.montant_total|floatformat:0 }} FCFA</span>
            </div>
            {% if facture_info.paiement_partiel %}
            <div class="total-row">
              <span>Montant versé :</span>
              <span style="color: #059669;">{{ facture_info.montant_verse|floatformat:0 }} FCFA</span>
            </div>
            <div class="total-row">
              <span>Reste à payer :</span>
              <span style="color: #dc2626;">{{ facture_info.reste_a_payer|floatformat:0 }} FCFA</span>
            </div>
            {% if facture_info.date_echeance_reste %}
            <div class="total-row">
              <span>Échéance du reste :</span>
              <span>{{ facture_info.date_echeance_reste|date:"d F Y" }}</span>
            </div>
            {% endif %}
            {% endif %}
            <div class="total-row total-final">
              <span><strong>{% if facture_info.paiement_partiel %}Montant total de la facture{% else %}Total payé{% endif %} :</strong></span>
              <span><strong>{{ facture_info.montant_total|floatformat:0 }} FCFA</strong></span>
            </div>
          </div>
        </div>

        <!-- Facture Number -->
        <div class="facture-number-section">
          <div class="facture-number-display">
            <h3>Numéro de Facture :</h3>
            <div class="facture-number-box">
              <span class="facture-number">{{ facture_info.numero }}</span>
            </div>
          </div>
        </div>

        <!-- Invoice Footer -->
        <div class="invoice-footer">
          <div class="footer-left">
            <p><strong>Merci pour votre confiance !</strong></p>
            <p>
              Pour toute question concernant cette facture, contactez-nous :
            </p>
            <p>Email : facturation@goo-school.com | Tél : +237 6XX XX XX XX</p>
          </div>
          <div class="footer-right">
            <div class="signature">
              <p>Signature :</p>
              <div class="signature-line"></div>
              <p>Directeur Financier</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="{% static 'school_admin/js/gestion_comptable/facture_etablissement.js' %}"></script>
  </body>
</html>
