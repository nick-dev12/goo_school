{% load static %}
<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestion des Dépenses - Goo-School</title>
    <link
      rel="stylesheet"
      href="{% static 'school_admin/css/gestion_comptable/header_comptable.css' %}"
    />
    <link
      rel="stylesheet"
      href="{% static 'school_admin/css/gestion_comptable/gestion_depenses.css' %}"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
  </head>
  <body>
    <!-- Header Comptable -->
    {% include 'school_admin/gestion_comptable/partials/header_comptable.html'%}

    <div class="comptable-container">
      <!-- Main Content -->
      <div class="container">
        <!-- Page Header -->
        <div class="page-header">
          <div class="header-left">
            <h1><i class="fas fa-credit-card"></i> Gestion des Dépenses</h1>
            <p>Gérez et suivez toutes les dépenses de l'organisation</p>
          </div>
          <div class="header-actions">
            <button class="btn btn-primary" onclick="document.getElementById('addExpenseModal').style.display='block'">
              <i class="fas fa-plus"></i> Nouvelle Dépense
            </button>
            <button class="btn btn-success" onclick="generateExpenseReport()">
              <i class="fas fa-file-excel"></i> Rapport Dépenses
            </button>
            <button class="btn btn-warning" onclick="openBudgetModal()">
              <i class="fas fa-chart-pie"></i> Budget
            </button>
          </div>
        </div>

        <!-- Messages Django -->
        {% include 'school_admin/partials/messages.html' %}

        <!-- Summary Cards -->
        <div class="summary-cards">
          <div class="summary-card">
            <div class="card-icon neo-red">
              <i class="fas fa-credit-card"></i>
            </div>
            <div class="card-content">
              <h3>{{ montant_total|floatformat:0 }} FCFA</h3>
              <p>Total Dépenses</p>
            </div>
          </div>
          <div class="summary-card">
            <div class="card-icon neo-orange">
              <i class="fas fa-chart-line"></i>
            </div>
            <div class="card-content">
              <h3>{{ total_depenses }}</h3>
              <p>Nombre de Dépenses</p>
            </div>
          </div>
          <div class="summary-card">
            <div class="card-icon neo-blue">
              <i class="fas fa-list"></i>
            </div>
            <div class="card-content">
              <h3>{{ stats_statuts.en_attente.count }}</h3>
              <p>En Attente</p>
            </div>
          </div>
          <div class="summary-card">
            <div class="card-icon neo-green">
              <i class="fas fa-check-circle"></i>
            </div>
            <div class="card-content">
              <h3>{{ stats_statuts.paye.count }}</h3>
              <p>Dépenses Payées</p>
            </div>
          </div>
        </div>

        <!-- Search and Filter Bar -->
        <div class="search-filter-bar">
          <div class="search-section">
            <div class="search-input-group">
              <i class="fas fa-search"></i>
              <input
                type="text"
                id="searchInput"
                name="search"
                value="{{ search_query }}"
                placeholder="Rechercher par description, catégorie ou montant..."
              />
            </div>
            <button class="btn btn-secondary" onclick="clearSearch()">
              <i class="fas fa-times"></i> Effacer
            </button>
          </div>
          <div class="filter-section">
            <form method="GET" id="filterForm">
              <select name="categorie" class="filter-select">
                <option value="">Toutes les catégories</option>
                <option value="personnel" {% if categorie_filter == 'personnel' %}selected{% endif %}>Personnel</option>
                <option value="equipement" {% if categorie_filter == 'equipement' %}selected{% endif %}>Équipement</option>
                <option value="maintenance" {% if categorie_filter == 'maintenance' %}selected{% endif %}>Maintenance</option>
                <option value="formation" {% if categorie_filter == 'formation' %}selected{% endif %}>Formation</option>
                <option value="marketing" {% if categorie_filter == 'marketing' %}selected{% endif %}>Marketing</option>
                <option value="bureau" {% if categorie_filter == 'bureau' %}selected{% endif %}>Bureau</option>
                <option value="transport" {% if categorie_filter == 'transport' %}selected{% endif %}>Transport</option>
                <option value="loyer" {% if categorie_filter == 'loyer' %}selected{% endif %}>Loyer</option>
                <option value="autre" {% if categorie_filter == 'autre' %}selected{% endif %}>Autre</option>
              </select>
              <select name="statut" class="filter-select">
                <option value="">Tous les statuts</option>
                <option value="en_attente" {% if statut_filter == 'en_attente' %}selected{% endif %}>En attente</option>
                <option value="approuve" {% if statut_filter == 'approuve' %}selected{% endif %}>Approuvé</option>
                <option value="rejete" {% if statut_filter == 'rejete' %}selected{% endif %}>Rejeté</option>
                <option value="paye" {% if statut_filter == 'paye' %}selected{% endif %}>Payé</option>
              </select>
              <select name="montant" class="filter-select">
                <option value="">Toutes les tranches</option>
                <option value="0-50000" {% if montant_filter == '0-50000' %}selected{% endif %}>0 - 50,000 FCFA</option>
                <option value="50000-200000" {% if montant_filter == '50000-200000' %}selected{% endif %}>50,000 - 200,000 FCFA</option>
                <option value="200000-500000" {% if montant_filter == '200000-500000' %}selected{% endif %}>200,000 - 500,000 FCFA</option>
                <option value="500000+" {% if montant_filter == '500000+' %}selected{% endif %}>500,000+ FCFA</option>
              </select>
              <input type="date" name="date" value="{{ date_filter }}" class="filter-select" />
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-filter"></i> Filtrer
              </button>
            </form>
          </div>
        </div>

        <!-- Main Content Tabs -->
        <div class="tabs-container">
          <div class="tabs-header">
            <button
              class="tab-btn active"
              onclick="switchTab('liste-depenses')"
            >
              <i class="fas fa-list"></i> Liste des Dépenses
            </button>
            <button class="tab-btn" onclick="switchTab('categories')">
              <i class="fas fa-tags"></i> Catégories
            </button>
            <button class="tab-btn" onclick="switchTab('budget')">
              <i class="fas fa-chart-pie"></i> Budget & Analyse
            </button>
            <button class="tab-btn" onclick="switchTab('rapports')">
              <i class="fas fa-chart-bar"></i> Rapports
            </button>
          </div>

          <!-- Tab 1: Liste des Dépenses -->
          <div id="liste-depenses" class="tab-panel active">
            <div class="panel-header">
              <h3>Liste des Dépenses</h3>
              <div class="panel-actions">
                <button class="btn btn-success" onclick="exportExpensesList()">
                  <i class="fas fa-download"></i> Exporter
                </button>
                <button class="btn btn-warning" onclick="bulkApprove()">
                  <i class="fas fa-check"></i> Confirmer Sélection
                </button>
              </div>
            </div>

            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th><input type="checkbox" id="selectAllExpenses" /></th>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Catégorie</th>
                    <th>Montant</th>
                    <th>Statut</th>
                    <th>Fournisseur</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for depense in depenses %}
                  <tr>
                    <td><input type="checkbox" class="row-checkbox" /></td>
                    <td><span class="date">{{ depense.date_depense|date:"d M Y" }}</span></td>
                    <td>
                      <div class="expense-info">
                        <h4>{{ depense.description }}</h4>
                        {% if depense.notes %}
                          <p>{{ depense.notes|truncatechars:50 }}</p>
                        {% endif %}
                      </div>
                    </td>
                    <td>
                      <span class="category {{ depense.categorie }}" style="background-color: {{ depense.get_categorie_display_color }}20; color: {{ depense.get_categorie_display_color }};">
                        {{ depense.get_categorie_display }}
                      </span>
                    </td>
                    <td><span class="amount">{{ depense.get_montant_formatted }}</span></td>
                    <td>
                      <span class="status-badge {{ depense.statut }}" style="background-color: {{ depense.get_statut_display_color }}20; color: {{ depense.get_statut_display_color }};">
                        {{ depense.get_statut_display }}
                      </span>
                    </td>
                    <td><span class="supplier">{{ depense.fournisseur }}</span></td>
                    <td>
                      <div class="action-buttons">
                        <a href="{% url 'school_admin:modifier_depense' depense.id %}" class="btn-action" title="Modifier">
                          <i class="fas fa-edit"></i>
                        </a>
                        {% if depense.statut == 'en_attente' %}
                        <a href="{% url 'school_admin:confirmer_depense' depense.id %}" class="btn-action" title="Confirmer dépense" onclick="return confirm('Confirmer que cette dépense a été effectuée ?')">
                          <i class="fas fa-check-circle"></i>
                        </a>
                        {% endif %}
                        {% if depense.can_be_paid %}
                          <form method="POST" style="display: inline;">
                            {% csrf_token %}
                            <input type="hidden" name="depense_id" value="{{ depense.id }}">
                            <button type="submit" name="pay_expense" class="btn-action" title="Marquer comme payé">
                              <i class="fas fa-money-bill"></i>
                            </button>
                          </form>
                        {% endif %}
                        {% if depense.piece_jointe %}
                          <a href="{{ depense.piece_jointe.url }}" class="btn-action" title="Télécharger pièce jointe" target="_blank">
                            <i class="fas fa-download"></i>
                          </a>
                        {% endif %}
                      </div>
                    </td>
                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="8" class="text-center">
                      <div class="empty-state">
                        <i class="fas fa-receipt"></i>
                        <h3>Aucune dépense trouvée</h3>
                        <p>Commencez par ajouter une nouvelle dépense.</p>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <!-- Tab 2: Catégories -->
          <div id="categories" class="tab-panel">
            <div class="panel-header">
              <h3>Gestion des Catégories</h3>
              <div class="panel-actions">
                <button
                  class="btn btn-primary"
                  onclick="openAddCategoryModal()"
                >
                  <i class="fas fa-plus"></i> Nouvelle Catégorie
                </button>
              </div>
            </div>

            <!-- Categories Grid -->
            <div class="categories-grid">
              {% for categorie, stats in stats_categories.items %}
              <div class="category-card">
                <div class="category-header">
                  <div class="category-icon {{ categorie }}">
                    <i class="fas fa-{% if categorie == 'personnel' %}users{% elif categorie == 'equipement' %}laptop{% elif categorie == 'maintenance' %}tools{% elif categorie == 'formation' %}graduation-cap{% elif categorie == 'marketing' %}bullhorn{% elif categorie == 'bureau' %}building{% elif categorie == 'transport' %}truck{% elif categorie == 'loyer' %}home{% else %}receipt{% endif %}"></i>
                  </div>
                  <div class="category-info">
                    <h4>{{ categorie|title }}</h4>
                    <p>{% if categorie == 'personnel' %}Salaires et avantages{% elif categorie == 'equipement' %}Matériel informatique et bureau{% elif categorie == 'maintenance' %}Réparations et entretien{% elif categorie == 'formation' %}Formation et développement{% elif categorie == 'marketing' %}Publicité et communication{% elif categorie == 'bureau' %}Fournitures de bureau{% elif categorie == 'transport' %}Transport et déplacements{% elif categorie == 'loyer' %}Loyers et charges{% else %}Autres dépenses{% endif %}</p>
                  </div>
                </div>
                <div class="category-stats">
                  <div class="stat-item">
                    <span class="stat-value">{{ stats.total|floatformat:0 }} FCFA</span>
                    <span class="stat-label">Total</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-value">{{ stats.count }}</span>
                    <span class="stat-label">Transactions</span>
                  </div>
                </div>
                <div class="category-actions">
                  <button class="btn-action" onclick="filterByCategory('{{ categorie }}')" title="Filtrer par catégorie">
                    <i class="fas fa-filter"></i>
                  </button>
                  <button class="btn-action" onclick="viewCategoryDetails('{{ categorie }}')" title="Voir détails">
                    <i class="fas fa-eye"></i>
                  </button>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>

          <!-- Tab 3: Budget & Analyse -->
          <div id="budget" class="tab-panel">
            <div class="panel-header">
              <h3>Budget & Analyse</h3>
              <div class="panel-actions">
                <button class="btn btn-primary" onclick="document.getElementById('addBudgetModal').style.display='block'">
                  <i class="fas fa-plus"></i> Ajouter Budget
                </button>
                <button class="btn btn-warning" onclick="document.getElementById('editBudgetModal').style.display='block'">
                  <i class="fas fa-edit"></i> Modifier Budget
                </button>
              </div>
            </div>

            <!-- Budget Overview -->
            <div class="budget-overview">
              <div class="budget-card">
                <h4>Budget Total</h4>
                <div class="budget-amount">{{ budget_total|floatformat:0 }} FCFA</div>
                <div class="budget-progress">
                  <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ pourcentage_utilise }}%"></div>
                  </div>
                  <span class="progress-text">{{ pourcentage_utilise }}% utilisé</span>
                </div>
              </div>
              <div class="budget-card">
                <h4>Dépenses Réalisées</h4>
                <div class="budget-amount">{{ depenses_total|floatformat:0 }} FCFA</div>
                <div class="budget-remaining">
                  <span class="remaining-amount">{{ budget_restant|floatformat:0 }} FCFA restants</span>
                </div>
              </div>
            </div>

            <!-- Budget by Category -->
            <div class="budget-categories">
              <h3>Budget par Catégorie</h3>
              <div class="budget-list">
                {% for budget in budgets_actifs %}
                <div class="budget-item">
                  <div class="budget-category">
                    <span class="category-name">{{ budget.get_categorie_display }}</span>
                    <span class="category-amount">{{ budget.get_montant_alloue_formatted }}</span>
                  </div>
                  <div class="budget-progress">
                    <div class="progress-bar">
                      <div class="progress-fill" style="width: {{ budget.get_pourcentage_utilise }}%"></div>
                    </div>
                    <span class="progress-text">{{ budget.get_montant_depense|floatformat:0 }} / {{ budget.montant_alloue|floatformat:0 }}</span>
                  </div>
                  <div class="budget-actions">
                    <button class="btn-action" onclick="editBudget({{ budget.id }})" title="Modifier">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-action" onclick="deleteBudget({{ budget.id }})" title="Supprimer">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
                {% empty %}
                <div class="empty-state">
                  <i class="fas fa-chart-pie"></i>
                  <h3>Aucun budget configuré</h3>
                  <p>Commencez par ajouter un budget pour une catégorie.</p>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>

          <!-- Tab 4: Rapports -->
          <div id="rapports" class="tab-panel">
            <div class="panel-header">
              <h3>Rapports de Dépenses</h3>
              <div class="panel-actions">
                <button
                  class="btn btn-success"
                  onclick="generateExpenseReport()"
                >
                  <i class="fas fa-file-pdf"></i> Générer Rapport
                </button>
              </div>
            </div>

            <!-- Report Tools -->
            <div class="report-tools">
              <div class="tool-card">
                <div class="tool-header">
                  <h4>
                    <i class="fas fa-chart-line"></i> Analyse des Tendances
                  </h4>
                </div>
                <div class="tool-content">
                  <div class="form-group">
                    <label>Période</label>
                    <select class="form-input">
                      <option>Ce mois</option>
                      <option>3 derniers mois</option>
                      <option>6 derniers mois</option>
                      <option>Cette année</option>
                    </select>
                  </div>
                  <button class="btn btn-primary" onclick="analyzeTrends()">
                    <i class="fas fa-chart-line"></i> Analyser
                  </button>
                </div>
              </div>

              <div class="tool-card">
                <div class="tool-header">
                  <h4>
                    <i class="fas fa-balance-scale"></i> Comparaison Budget
                  </h4>
                </div>
                <div class="tool-content">
                  <div class="form-group">
                    <label>Catégorie</label>
                    <select class="form-input">
                      <option>Toutes</option>
                      <option>Personnel</option>
                      <option>Équipement</option>
                      <option>Formation</option>
                      <option>Maintenance</option>
                    </select>
                  </div>
                  <button class="btn btn-primary" onclick="compareBudget()">
                    <i class="fas fa-balance-scale"></i> Comparer
                  </button>
                </div>
              </div>

              <div class="tool-card">
                <div class="tool-header">
                  <h4><i class="fas fa-download"></i> Export de Données</h4>
                </div>
                <div class="tool-content">
                  <div class="form-group">
                    <label>Format</label>
                    <select class="form-input">
                      <option>Excel (.xlsx)</option>
                      <option>CSV (.csv)</option>
                      <option>PDF (.pdf)</option>
                    </select>
                  </div>
                  <button class="btn btn-primary" onclick="exportData()">
                    <i class="fas fa-download"></i> Exporter
                  </button>
                </div>
              </div>
            </div>

            <!-- Financial Summary -->
            <div class="financial-summary">
              <h3>Résumé Financier</h3>
              <div class="summary-grid">
                <div class="summary-item">
                  <h4>2,450,000 FCFA</h4>
                  <p>Dépenses Totales</p>
                </div>
                <div class="summary-item">
                  <h4>550,000 FCFA</h4>
                  <p>Budget Restant</p>
                </div>
                <div class="summary-item">
                  <h4>127</h4>
                  <p>Transactions</p>
                </div>
                <div class="summary-item">
                  <h4>98%</h4>
                  <p>Taux d'Approbation</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modals -->
    <!-- Add Expense Modal -->
    <div id="addExpenseModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Nouvelle Dépense</h3>
          <span class="close" onclick="closeModal('addExpenseModal')"
            >&times;</span
          >
        </div>
        <div class="modal-body">
          <form id="addExpenseForm" class="expense-form" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="add_expense" value="1">
            <div class="form-row">
              <div class="form-group">
                <label>Description *</label>
                <input type="text" name="description" class="form-input" required />
              </div>
              <div class="form-group">
                <label>Montant (FCFA) *</label>
                <input type="number" name="montant" class="form-input" step="0.01" min="0" required />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Catégorie *</label>
                <select name="categorie" class="form-input" required>
                  <option value="">Sélectionner</option>
                  <option value="personnel">Personnel</option>
                  <option value="equipement">Équipement</option>
                  <option value="maintenance">Maintenance</option>
                  <option value="formation">Formation</option>
                  <option value="marketing">Marketing</option>
                  <option value="bureau">Bureau</option>
                  <option value="transport">Transport</option>
                  <option value="loyer">Loyer</option>
                  <option value="autre">Autre</option>
                </select>
              </div>
              <div class="form-group">
                <label>Date de dépense *</label>
                <input type="date" name="date_depense" class="form-input" required />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Fournisseur *</label>
                <input type="text" name="fournisseur" class="form-input" required />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Établissement (optionnel)</label>
                <select name="etablissement" class="form-input">
                  <option value="">Aucun établissement</option>
                  {% for etablissement in etablissements %}
                    <option value="{{ etablissement.id }}">{{ etablissement.nom }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="form-group">
              <label>Notes</label>
              <textarea
                name="notes"
                class="form-input"
                rows="3"
                placeholder="Notes additionnelles..."
              ></textarea>
            </div>
            <div class="form-group">
              <label>Pièce jointe</label>
              <input type="file" name="piece_jointe" class="form-input" accept=".pdf,.jpg,.png,.doc,.docx" />
              <small class="form-text">Formats acceptés: PDF, JPG, PNG, DOC, DOCX</small>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="closeModal('addExpenseModal')"
          >
            Annuler
          </button>
          <button type="submit" form="addExpenseForm" class="btn btn-primary">
            Enregistrer
          </button>
        </div>
      </div>
    </div>

    <!-- Edit Expense Modal -->
    <div id="editExpenseModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Modifier la Dépense</h3>
          <span class="close" onclick="closeModal('editExpenseModal')"
            >&times;</span
          >
        </div>
        <div class="modal-body">
          <form class="expense-form">
            <div class="form-row">
              <div class="form-group">
                <label>Description</label>
                <input type="text" class="form-input" required />
              </div>
              <div class="form-group">
                <label>Montant</label>
                <input type="number" class="form-input" required />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Catégorie</label>
                <select class="form-input" required>
                  <option value="">Sélectionner</option>
                  <option value="personnel">Personnel</option>
                  <option value="equipement">Équipement</option>
                  <option value="maintenance">Maintenance</option>
                  <option value="formation">Formation</option>
                  <option value="marketing">Marketing</option>
                  <option value="bureau">Bureau</option>
                  <option value="transport">Transport</option>
                  <option value="autre">Autre</option>
                </select>
              </div>
              <div class="form-group">
                <label>Statut</label>
                <select class="form-input" required>
                  <option value="en_attente">En attente</option>
                  <option value="approuve">Approuvé</option>
                  <option value="rejete">Rejeté</option>
                  <option value="paye">Payé</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label>Notes</label>
              <textarea
                class="form-input"
                rows="3"
                placeholder="Notes additionnelles..."
              ></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="closeModal('editExpenseModal')"
          >
            Annuler
          </button>
          <button class="btn btn-primary" onclick="saveExpenseChanges()">
            Enregistrer
          </button>
        </div>
      </div>
    </div>

    <!-- Add Budget Modal -->
    <div id="addBudgetModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Ajouter un Budget</h3>
          <span class="close" onclick="closeModal('addBudgetModal')">&times;</span>
        </div>
        <div class="modal-body">
          <form id="addBudgetForm" method="POST" action="{% url 'school_admin:ajouter_budget' %}">
            {% csrf_token %}
            <input type="hidden" name="add_budget" value="1">
            <div class="form-group">
              <label>Nom du budget *</label>
              <input type="text" name="nom" class="form-input" required placeholder="Ex: Budget Personnel 2024" />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Catégorie *</label>
                <select name="categorie" class="form-input" required>
                  <option value="">Sélectionner une catégorie</option>
                  <option value="personnel">Personnel</option>
                  <option value="equipement">Équipement</option>
                  <option value="maintenance">Maintenance</option>
                  <option value="formation">Formation</option>
                  <option value="marketing">Marketing</option>
                  <option value="bureau">Bureau</option>
                  <option value="transport">Transport</option>
                  <option value="loyer">Loyer</option>
                  <option value="autre">Autre</option>
                </select>
              </div>
              <div class="form-group">
                <label>Période *</label>
                <select name="periode" class="form-input" required>
                  <option value="">Sélectionner une période</option>
                  <option value="mensuel">Mensuel</option>
                  <option value="trimestriel">Trimestriel</option>
                  <option value="annuel">Annuel</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Montant alloué (FCFA) *</label>
                <input type="number" name="montant_alloue" class="form-input" step="0.01" min="0" required />
              </div>
              <div class="form-group">
                <label>Date de début *</label>
                <input type="date" name="date_debut" class="form-input" required />
              </div>
            </div>
            <div class="form-group">
              <label>Date de fin *</label>
              <input type="date" name="date_fin" class="form-input" required />
            </div>
            <div class="form-group">
              <label>Notes</label>
              <textarea name="notes" class="form-input" rows="3" placeholder="Notes additionnelles sur le budget..."></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal('addBudgetModal')">
            Annuler
          </button>
          <button type="submit" form="addBudgetForm" class="btn btn-primary">
            Enregistrer
          </button>
        </div>
      </div>
    </div>

    <!-- Edit Budget Modal -->
    <div id="editBudgetModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Modifier le Budget</h3>
          <span class="close" onclick="closeModal('editBudgetModal')">&times;</span>
        </div>
        <div class="modal-body">
          <form id="editBudgetForm" method="POST">
            {% csrf_token %}
            <input type="hidden" name="edit_budget" value="1">
            <input type="hidden" name="budget_id" id="edit_budget_id">
            <div class="form-group">
              <label>Nom du budget *</label>
              <input type="text" name="nom" id="edit_nom" class="form-input" required />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Catégorie *</label>
                <select name="categorie" id="edit_categorie" class="form-input" required>
                  <option value="">Sélectionner une catégorie</option>
                  <option value="personnel">Personnel</option>
                  <option value="equipement">Équipement</option>
                  <option value="maintenance">Maintenance</option>
                  <option value="formation">Formation</option>
                  <option value="marketing">Marketing</option>
                  <option value="bureau">Bureau</option>
                  <option value="transport">Transport</option>
                  <option value="loyer">Loyer</option>
                  <option value="autre">Autre</option>
                </select>
              </div>
              <div class="form-group">
                <label>Période *</label>
                <select name="periode" id="edit_periode" class="form-input" required>
                  <option value="">Sélectionner une période</option>
                  <option value="mensuel">Mensuel</option>
                  <option value="trimestriel">Trimestriel</option>
                  <option value="annuel">Annuel</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Montant alloué (FCFA) *</label>
                <input type="number" name="montant_alloue" id="edit_montant_alloue" class="form-input" step="0.01" min="0" required />
              </div>
              <div class="form-group">
                <label>Date de début *</label>
                <input type="date" name="date_debut" id="edit_date_debut" class="form-input" required />
              </div>
            </div>
            <div class="form-group">
              <label>Date de fin *</label>
              <input type="date" name="date_fin" id="edit_date_fin" class="form-input" required />
            </div>
            <div class="form-group">
              <label>Notes</label>
              <textarea name="notes" id="edit_notes" class="form-input" rows="3" placeholder="Notes additionnelles sur le budget..."></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal('editBudgetModal')">
            Annuler
          </button>
          <button type="submit" form="editBudgetForm" class="btn btn-primary">
            Enregistrer
          </button>
        </div>
      </div>
    </div>

    <script>
      // Gestion des modals
      function openAddExpenseModal() {
        document.getElementById('addExpenseModal').style.display = 'block';
      }
      
      function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
      }
      
      // Fermer le modal en cliquant à l'extérieur
      window.onclick = function(event) {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
          if (event.target === modal) {
            modal.style.display = 'none';
          }
        });
      }
      
      // Gestion des onglets
      function switchTab(tabId) {
        // Masquer tous les panneaux
        const panels = document.querySelectorAll('.tab-panel');
        panels.forEach(panel => panel.classList.remove('active'));
        
        // Désactiver tous les boutons d'onglets
        const buttons = document.querySelectorAll('.tab-btn');
        buttons.forEach(button => button.classList.remove('active'));
        
        // Afficher le panneau sélectionné
        document.getElementById(tabId).classList.add('active');
        
        // Activer le bouton correspondant
        event.target.classList.add('active');
      }
      
      // Fonctions de filtrage
      function filterByCategory(category) {
        const form = document.getElementById('filterForm');
        const categorySelect = form.querySelector('select[name="categorie"]');
        categorySelect.value = category;
        form.submit();
      }
      
      function clearSearch() {
        document.getElementById('searchInput').value = '';
        // Optionnel: soumettre le formulaire pour effacer les filtres
        const form = document.getElementById('filterForm');
        if (form) {
          form.submit();
        }
      }
      
      // Fonctions pour les rapports (à implémenter)
      function generateExpenseReport() {
        alert('Fonction de génération de rapport à implémenter');
      }
      
      function openBudgetModal() {
        alert('Fonction de budget à implémenter');
      }
      
      function exportExpensesList() {
        alert('Fonction d\'export à implémenter');
      }
      
      function bulkApprove() {
        alert('Fonction d\'approbation en lot à implémenter');
      }
      
      function editExpense(id) {
        alert('Fonction d\'édition à implémenter pour l\'ID: ' + id);
      }
      
      function viewExpenseDetails(id) {
        alert('Fonction de détails à implémenter pour l\'ID: ' + id);
      }
      
      function downloadInvoice(id) {
        alert('Fonction de téléchargement à implémenter pour l\'ID: ' + id);
      }
      
      function openAddCategoryModal() {
        alert('Fonction d\'ajout de catégorie à implémenter');
      }
      
      function editCategory(id) {
        alert('Fonction d\'édition de catégorie à implémenter pour l\'ID: ' + id);
      }
      
      function viewCategoryDetails(category) {
        alert('Fonction de détails de catégorie à implémenter pour: ' + category);
      }
      
      function analyzeTrends() {
        alert('Fonction d\'analyse des tendances à implémenter');
      }
      
      function compareBudget() {
        alert('Fonction de comparaison de budget à implémenter');
      }
      
      function exportData() {
        alert('Fonction d\'export de données à implémenter');
      }
      
      // Fonctions pour la gestion des budgets
      function editBudget(budgetId) {
        // Remplir le formulaire de modification avec les données du budget
        // Cette fonction sera appelée depuis le serveur avec les données
        document.getElementById('editBudgetModal').style.display = 'block';
        // TODO: Charger les données du budget via AJAX
      }
      
      function deleteBudget(budgetId) {
        if (confirm('Êtes-vous sûr de vouloir supprimer ce budget ?')) {
          // TODO: Implémenter la suppression
          alert('Fonction de suppression à implémenter pour l\'ID: ' + budgetId);
        }
      }
    </script>
  </body>
</html>

