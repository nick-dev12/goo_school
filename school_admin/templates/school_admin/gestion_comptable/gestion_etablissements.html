{% load static %}
<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestion des Établissements - Goo-School</title>
    <link
      rel="stylesheet"
      href="{% static 'school_admin/css/gestion_comptable/header_comptable.css' %}"
    />
    <link
      rel="stylesheet"
      href="{% static 'school_admin/css/gestion_comptable/gestion_etablissements.css' %}"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
  </head>
  <body>
    {% include 'school_admin/gestion_comptable/partials/header_comptable.html'%}

    <div class="dashboard-content">
      <!-- Page Header -->
      <div class="page-header">
        <div class="header-left">
          <h1><i class="fas fa-chalkboard"></i> Gestion des Établissements</h1>
          <p>Gestion des établissements et facturation</p>
        </div>
        <div class="header-actions">
          <button class="btn btn-secondary" onclick="refreshData()">
            <i class="fas fa-sync-alt"></i> Actualiser
          </button>
          <button class="btn btn-primary" onclick="exportAllData()">
            <i class="fas fa-download"></i> Exporter tout
          </button>
          <button class="btn btn-success" onclick="generateAllInvoices()">
            <i class="fas fa-file-invoice"></i> Générer toutes les factures
          </button>
        </div>
      </div>

      <!-- Summary Cards -->
      <div class="summary-cards">
        <div class="summary-card">
          <div class="card-icon">
            <i class="fas fa-school"></i>
          </div>
          <div class="card-content">
            <h3>Total Établissements</h3>
            <div class="card-value">{{ total_etablissements }}</div>
            <div class="card-change positive">+3 ce mois</div>
          </div>
        </div>
        <div class="summary-card">
          <div class="card-icon">
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="card-content">
            <h3>En Règle</h3>
            <div class="card-value">{{ nombre_en_regle }}</div>
            <div class="card-change positive">{{ pourcentage_en_regle }}%</div>
          </div>
        </div>
        <div class="summary-card">
          <div class="card-icon">
            <i class="fas fa-exclamation-triangle"></i>
          </div>
          <div class="card-content">
            <h3>Non en Règle</h3>
            <div class="card-value">{{ nombre_non_en_regle }}</div>
            <div class="card-change negative">{{ pourcentage_non_en_regle }}%</div>
          </div>
        </div>
        <div class="summary-card">
          <div class="card-icon">
            <i class="fas fa-file-invoice"></i>
          </div>
          <div class="card-content">
            <h3>Factures Générées</h3>
            <div class="card-value">{{ factures_generees }}</div>
            <div class="card-change positive">{{ pourcentage_factures }}%</div>
          </div>
        </div>
      </div>

      <!-- Search and Filter Bar -->
      <div class="search-filter-bar">
        <div class="search-section">
          <div class="search-input">
            <i class="fas fa-search"></i>
            <input
              type="text"
              id="searchInput"
              placeholder="Rechercher un établissement..."
            />
          </div>
          <div class="filter-select">
            <select id="statusFilter">
              <option value="">Tous les statuts</option>
              <option value="en_regle">En règle</option>
              <option value="non_en_regle">Non en règle</option>
              <option value="en_attente">En attente</option>
            </select>
          </div>
          <div class="filter-select">
            <select id="typeFilter">
              <option value="">Tous les types</option>
              <option value="prive">Privé</option>
              <option value="public">Public</option>
              <option value="semi_prive">Semi-privé</option>
            </select>
          </div>
        </div>
        <div class="action-section">
          <button class="btn btn-outline" onclick="selectAll()">
            <i class="fas fa-check-square"></i> Tout sélectionner
          </button>
          <button class="btn btn-outline" onclick="clearSelection()">
            <i class="fas fa-square"></i> Désélectionner
          </button>
        </div>
      </div>

      <!-- Tabs Container -->
      <div class="tabs-container">
        <div class="tabs-header">
          <button class="tab-btn active" data-tab="etablissements-en-regle">
            <i class="fas fa-check-circle"></i> Établissements en Règle
          </button>
          <button class="tab-btn" data-tab="etablissements-non-en-regle">
            <i class="fas fa-exclamation-triangle"></i> Non en Règle
          </button>
          <button class="tab-btn" data-tab="factures">
            <i class="fas fa-file-invoice"></i> Factures
          </button>
        </div>

        <!-- Tab: Établissements en Règle -->
        <div id="etablissements-en-regle" class="tab-panel active">
          <div class="panel-header">
            <h3>Établissements en Règle</h3>
            <div class="panel-actions">
              <button
                class="btn btn-success"
                onclick="generateInvoicesForSelected()"
              >
                <i class="fas fa-file-invoice"></i> Générer factures
                sélectionnées
              </button>
            </div>
          </div>
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th><input type="checkbox" id="selectAllEnRegle" /></th>
                  <th>Établissement</th>
                  <th>Type</th>
                  <th>Élèves</th>
                  <th>Montant Total</th>
                  <th>Dernier Paiement</th>
                  <th>Statut</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for etablissement in etablissements_en_regle_detailed %}
                <tr>
                  <td><input type="checkbox" class="row-checkbox" /></td>
                  <td>
                    <div class="etablissement-info">
                      <h4>{{ etablissement.etablissement.nom }}</h4>
                      <p>{{ etablissement.etablissement.ville }}, {{ etablissement.etablissement.pays }}</p>
                    </div>
                  </td>
                  <td><span class="type-badge 
                    {% if etablissement.etablissement.type_etablissement == 'primary' %}prive
                    {% elif etablissement.etablissement.type_etablissement == 'collège' %}semi_prive
                    {% else %}public{% endif %}">
                    {% if etablissement.etablissement.type_etablissement == 'primary' %}Privé
                    {% elif etablissement.etablissement.type_etablissement == 'collège' %}Semi-privé
                    {% else %}Public{% endif %}
                  </span></td>
                  <td><span class="student-count">{{ etablissement.nombre_eleves }}</span></td>
                  <td><span class="amount">{{ etablissement.montant_total|floatformat:0 }} FCFA</span></td>
                  <td><span class="date">
                    {% if etablissement.date_dernier_paiement %}
                      {{ etablissement.date_dernier_paiement|date:"d M Y" }}
                    {% else %}
                      Aucun paiement
                    {% endif %}
                  </span></td>
                  <td>
                    <span class="status-badge 
                      {% if etablissement.statut_display == 'En règle' %}en-regle
                      {% elif etablissement.statut_display == 'Paiement en attente' %}en-attente
                      {% elif etablissement.statut_display == 'Paiement en retard' %}en-retard
                      {% elif etablissement.statut_display == 'Non en règle' %}non-en-regle
                      {% else %}en-regle{% endif %}">
                      {{ etablissement.statut_display }}
                    </span>
                  </td>
                  <td>
                    <div class="action-buttons">
                      <a href="{% url 'school_admin:details_financiers_etablissement' etablissement.etablissement.id %}">
                        <button class="btn-action" title="Voir détails">
                          <i class="fas fa-eye"></i>
                        </button>
                      </a>
                      <button class="btn-action" title="Générer facture">
                        <i class="fas fa-file-invoice"></i>
                      </button>
                      <button class="btn-action" title="Envoyer facture">
                        <i class="fas fa-paper-plane"></i>
                      </button>
                    </div>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="8" style="text-align: center; padding: 2rem;">
                    <div style="color: var(--text-secondary);">
                      <i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: 1rem; color: var(--success-color);"></i>
                      <p>Aucun établissement en règle</p>
                      <small>Tous les établissements ont des paiements en attente</small>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Tab: Établissements Non en Règle -->
        <div id="etablissements-non-en-regle" class="tab-panel">
          <div class="panel-header">
            <h3>Établissements Non en Règle</h3>
            <div class="panel-actions">
              <button class="btn btn-warning" onclick="sendReminders()">
                <i class="fas fa-bell"></i> Envoyer relances
              </button>
              <button class="btn btn-danger" onclick="escalateToLegal()">
                <i class="fas fa-gavel"></i> Escalader
              </button>
            </div>
          </div>
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th><input type="checkbox" id="selectAllNonEnRegle" /></th>
                  <th>Établissement</th>
                  <th>Type</th>
                  <th>Élèves</th>
                  <th>Montant Dû</th>
                  <th>Retard</th>
                  <th>Statut</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for etablissement in etablissements_non_en_regle_detailed %}
                <tr class="{% if etablissement.jours_retard > 30 %}urgent{% endif %}">
                  <td><input type="checkbox" class="row-checkbox" /></td>
                  <td>
                    <div class="etablissement-info">
                      <h4>{{ etablissement.etablissement.nom }}</h4>
                      <p>{{ etablissement.etablissement.ville }}, {{ etablissement.etablissement.pays }}</p>
                    </div>
                  </td>
                  <td><span class="type-badge 
                    {% if etablissement.etablissement.type_etablissement == 'primary' %}prive
                    {% elif etablissement.etablissement.type_etablissement == 'collège' %}semi_prive
                    {% else %}public{% endif %}">
                    {% if etablissement.etablissement.type_etablissement == 'primary' %}Privé
                    {% elif etablissement.etablissement.type_etablissement == 'collège' %}Semi-privé
                    {% else %}Public{% endif %}
                  </span></td>
                  <td><span class="student-count">{{ etablissement.nombre_eleves }}</span></td>
                  <td><span class="amount {% if etablissement.montant_du > 1000000 %}urgent{% endif %}">{{ etablissement.montant_du|floatformat:0 }} FCFA</span></td>
                  <td><span class="delay-badge 
                    {% if etablissement.jours_retard > 30 %}critical
                    {% elif etablissement.jours_retard > 15 %}warning
                    {% else %}info{% endif %}">
                    {{ etablissement.jours_retard }} jours
                  </span></td>
                  <td><span class="status-badge 
                    {% if etablissement.etablissement.statut_paiement == 'en_retard' %}en-retard
                    {% elif etablissement.etablissement.statut_paiement == 'en_attente' %}en-attente
                    {% else %}annule{% endif %}">
                    {{ etablissement.etablissement.get_statut_paiement_display }}
                  </span></td>
                  <td>
                    <div class="action-buttons">
                      <button class="btn-action" title="Voir détails">
                        <i class="fas fa-eye"></i>
                      </button>
                      <button class="btn-action" title="Envoyer relance">
                        <i class="fas fa-bell"></i>
                      </button>
                      <button class="btn-action" title="Contacter">
                        <i class="fas fa-phone"></i>
                      </button>
                    </div>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="8" style="text-align: center; padding: 2rem;">
                    <div style="color: var(--text-secondary);">
                      <i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: 1rem; color: var(--success-color);"></i>
                      <p>Aucun établissement en retard</p>
                      <small>Tous les établissements sont en règle</small>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Tab: Factures -->
        <div id="factures" class="tab-panel">
          <div class="panel-header">
            <h3>Gestion des Factures</h3>
            <div class="panel-actions">
              <button class="btn btn-success" onclick="sendSelectedInvoices()">
                <i class="fas fa-paper-plane"></i> Envoyer factures
                sélectionnées
              </button>
            </div>
          </div>

          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th><input type="checkbox" id="selectAllFactures" /></th>
                  <th>Numéro Facture</th>
                  <th>Établissement</th>
                  <th>Type Facture</th>
                  <th>Montant Total</th>
                  <th>Montant Payé</th>
                  <th>Reste à Payer</th>
                  <th>Statut</th>
                  <th>Date Échéance</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for facture in factures_detailed %}
                <tr class="{% if facture.facture.statut in 'en_retard,impaye,contentieux' %}urgent-row{% endif %}">
                  <td><input type="checkbox" class="row-checkbox" /></td>
                  <td>
                    <div class="invoice-info">
                      <h4>{{ facture.facture.numero_facture }}</h4>
                      <p>Créée le {{ facture.date_creation|date:"d M Y" }}</p>
                      {% if facture.paiement_partiel %}
                      <small class="partial-payment-indicator">⚠️ Paiement partiel</small>
                      {% endif %}
                    </div>
                  </td>
                  <td>
                    <div class="etablissement-info">
                      <h4>{{ facture.facture.etablissement.nom }}</h4>
                      <p>{{ facture.facture.etablissement.ville }}, {{ facture.facture.etablissement.pays }}</p>
                      <small>{{ facture.facture.etablissement.get_type_etablissement_display }}</small>
                    </div>
                  </td>
                  <td>
                    <div class="facture-type">
                      <span class="type-badge 
                        {% if facture.facture.type_facture == 'frais_service_mensuel' %}mensuel
                        {% elif facture.facture.type_facture == 'frais_service_annuel' %}annuel
                        {% else %}module{% endif %}">
                        {{ facture.type_facture_display }}
                      </span>
                    </div>
                  </td>
                  <td><span class="amount">{{ facture.montant_total|floatformat:0 }} FCFA</span></td>
                  <td><span class="amount paid">{{ facture.montant_paye|floatformat:0 }} FCFA</span></td>
                  <td>
                    <span class="amount remaining {% if facture.montant_restant > 0 %}urgent{% endif %}">
                      {{ facture.reste_a_payer|floatformat:0 }} FCFA
                    </span>
                    {% if facture.paiement_partiel and facture.date_echeance_reste %}
                    <br><small class="echeance-reste">Échéance: {{ facture.date_echeance_reste|date:"d M Y" }}</small>
                    {% endif %}
                  </td>
                  <td>
                    <span class="status-badge {{ facture.statut_color }}">
                      {{ facture.statut_display }}
                    </span>
                    {% if facture.statut_envoi %}
                    <br><small class="sent-indicator">📧 Envoyée</small>
                    {% endif %}
                  </td>
                  <td>
                    <span class="date {% if facture.facture.statut in 'en_retard,impaye,contentieux' %}overdue{% endif %}">
                      {{ facture.date_echeance|date:"d M Y" }}
                    </span>
                    {% if facture.facture.statut in 'en_retard,impaye,contentieux' %}
                    <br><small class="overdue-indicator">⚠️ En retard</small>
                    {% endif %}
                  </td>
                  <td>
                    <div class="action-buttons">
                      <a href="{% url 'school_admin:facture_etablissement' %}?facture_id={{ facture.facture.numero_facture }}&etablissement_id={{ facture.facture.etablissement.id }}" target="_blank">
                        <button class="btn-action" title="Voir facture">
                          <i class="fas fa-eye"></i>
                        </button>
                      </a>
                      {% if facture.facture.statut == 'paye' %}
                      <button class="btn-action" title="Télécharger PDF">
                        <i class="fas fa-download"></i>
                      </button>
                      {% if not facture.statut_envoi %}
                      <form method="POST" action="{% url 'school_admin:envoyer_facture' facture.facture.numero_facture facture.facture.etablissement.id %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn-action" title="Marquer comme envoyée">
                          <i class="fas fa-paper-plane"></i>
                        </button>
                      </form>
                      {% else %}
                      <button class="btn-action success" title="Facture envoyée" disabled>
                        <i class="fas fa-check-circle"></i>
                      </button>
                      {% endif %}
                      {% else %}
                      <a href="{% url 'school_admin:details_financiers_etablissement' facture.facture.etablissement.id %}">
                        <button class="btn-action" title="Marquer comme payée">
                          <i class="fas fa-check"></i>
                        </button>
                      </a>
                      <button class="btn-action warning" title="Envoyer relance">
                        <i class="fas fa-bell"></i>
                      </button>
                      {% endif %}
                    </div>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="10" style="text-align: center; padding: 2rem;">
                    <div style="color: var(--text-secondary);">
                      <i class="fas fa-file-invoice" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                      <p>Aucune facture générée</p>
                      <small>Les factures apparaîtront ici une fois créées</small>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script src="{% static 'school_admin/js/gestion_comptable/gestion_etablissements.js' %}"></script>
  </body>
</html>
